<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Substrate Defender v2.6 | Mandela Resistance</title>
    <style>
        :root {
            --matrix-green: #00ff41; --void-black: #0d0208; --text-white: #f0fdf4;
            --danger-red: #ff3131; --gold: #ffd700; --panel-bg: #111827; --border: #22c55e;
            --action-blue: #3b82f6;
        }
        body { font-family: 'Courier New', monospace; background: var(--void-black); color: var(--text-white); margin: 0; padding: 20px; line-height: 1.5; }
        .app-container { max-width: 1100px; margin: 0 auto; border: 2px solid var(--border); border-radius: 12px; background: rgba(13, 2, 8, 0.98); position: relative; }
        
        header { padding: 1.5rem; border-bottom: 2px solid var(--border); text-align: center; background: #052e16; }
        h1 { margin: 0; font-size: 1.8rem; text-shadow: 0 0 10px var(--matrix-green); }
        
        .main-layout { display: grid; grid-template-columns: 1fr 350px; gap: 20px; padding: 20px; }
        .card { border: 1px solid var(--border); padding: 1.5rem; border-radius: 8px; background: #000; margin-bottom: 15px; }
        
        /* Stats Dashboard */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { border: 1px solid var(--border); padding: 10px; text-align: center; background: #051a05; }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; color: var(--matrix-green); }
        .stat-val { font-size: 1.8rem; font-weight: bold; }

        /* Progress Meters */
        .meter-container { height: 25px; background: #111; border: 1px solid var(--border); border-radius: 13px; position: relative; margin: 10px 0; overflow: hidden; }
        #sapolsky-bar { height: 100%; width: 30%; background: var(--matrix-green); transition: 0.5s; }
        .limit-marker { position: absolute; left: 65%; top: 0; bottom: 0; width: 3px; background: var(--danger-red); box-shadow: 0 0 10px var(--danger-red); }

        /* Interaction Elements */
        .btn-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn { flex: 1; padding: 12px; border: 1px solid var(--matrix-green); background: none; color: var(--matrix-green); cursor: pointer; font-weight: bold; font-family: inherit; transition: 0.2s; min-width: 140px; }
        .btn:hover { background: var(--matrix-green); color: black; }
        .btn-mandela { border-color: var(--gold); color: var(--gold); }
        .btn-mandela:hover { background: var(--gold); color: black; }
        
        .event-log { font-size: 0.85rem; color: #a3e635; height: 180px; overflow-y: auto; border: 1px solid #14532d; padding: 10px; margin-top: 15px; background: #000a00; }
        .hidden { display: none !important; }
        .alert-msg { color: var(--danger-red); font-weight: bold; display: none; text-align: center; padding: 10px; border: 1px solid var(--danger-red); margin-top: 10px; }

        /* Orientation Overlay */
        #orientation-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal { max-width: 650px; border: 2px solid var(--border); padding: 30px; border-radius: 12px; background: #000; box-shadow: 0 0 30px var(--matrix-green); }

        .sidebar { font-size: 0.85rem; border-left: 1px solid var(--border); padding-left: 20px; }
        dt { font-weight: bold; color: var(--gold); margin-top: 10px; }
        dd { margin: 0 0 10px 0; color: #cbd5e1; }
    </style>
</head>
<body>

<div id="orientation-overlay">
    <div class="modal" role="dialog" aria-labelledby="modal-title">
        <h2 id="modal-title">Constructor Orientation: BRC Defense</h2>
        <p>Ethics is a <strong>metabolic achievement</strong>. To remain a "Self-Editor," you must perform work ($W$) to keep your biological hardware online.</p>
        <p><strong>The Mandela Precedent:</strong> Nelson Mandela performed daily exercise in his cell to keep his coherence high while under <strong>Intentional Extraction</strong>. He defended his substrate to preserve his future agency.</p>
        <p><strong>Your Goal:</strong> Diagnose challenges as <em>Intentional</em> or <em>Incidental</em> and deploy the correct defense to survive the shift.</p>
        <button class="btn" onclick="closeOrientation()">Enter Simulation</button>
    </div>
</div>

<div class="app-container">
    <header>
        <h1>SUBSTRATE DEFENDER v2.6</h1>
        <p>Grounded in the Physics of Ethics & Character Construction</p>
    </header>

    <div class="main-layout">
        <main>
            <div class="stat-grid">
                <div class="stat-box">
                    <span class="stat-label" id="budget-label">Metabolic Budget ($W$)</span>
                    <div id="budget-val" class="stat-val" aria-labelledby="budget-label">100</div>
                </div>
                <div class="stat-box">
                    <span class="stat-label" id="stress-label">Internal Stress ($L_{GC}$)</span>
                    <div id="stress-val" class="stat-val" aria-labelledby="stress-label">0.30</div>
                </div>
            </div>

            <label for="sapolsky-bar"><strong>Sapolsky Limit Monitor</strong> (65% Critical Threshold)</label>
            <div class="meter-container">
                <div id="sapolsky-bar" role="progressbar" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                <div class="limit-marker" title="Sapolsky Limit"></div>
            </div>

            <div id="status-alert" class="alert-msg">TRUNCATION DETECTED: CHARACTER DEPTH OFFLINE</div>

            <div class="card" id="interaction-panel">
                <h2 id="event-title">Simulation Standby</h2>
                <p id="event-desc">Waiting for environmental stressors to initialize...</p>
                
                <div id="diag-controls" class="hidden">
                    <p><strong>STEP 1: Diagnose Source of Harm</strong></p>
                    <div class="btn-group">
                        <button class="btn" onclick="diagnose('incidental')">Incidental Depletion</button>
                        <button class="btn" onclick="diagnose('intentional')">Intentional Extraction</button>
                    </div>
                </div>

                <div id="defense-controls" class="hidden">
                    <p><strong>STEP 2: Deploy Defensive Strategy</strong></p>
                    <div class="btn-group">
                        <button class="btn" onclick="defend('boundary')">Set Boundary (Redesign)</button>
                        <button class="btn btn-mandela" onclick="defend('mandela')">Mandela Protocol (Resistance)</button>
                    </div>
                </div>

                <div id="cycle-controls" style="margin-top:20px;">
                    <button id="next-btn" class="btn" onclick="triggerEvent()">Begin Next Challenge</button>
                    <button id="recover-btn" class="btn" style="border-color:#3b82f6; color:#3b82f6;" onclick="recover()">Rest & Community (+W)</button>
                </div>
            </div>

            <h3 id="log-heading">Defense Activity Log</h3>
            <div class="event-log" id="log" aria-labelledby="log-heading"></div>
        </main>

        <aside class="sidebar">
            <h2>The Extraction Matrix</h2>
            <dl>
                <dt>Intentional Extraction</dt>
                <dd>Systems that actively target your agency. <strong>Defense: Mandela Protocol (Resistance).</strong></dd>
                <dt>Incidental Depletion</dt>
                <dd>Systems that burn you out by accident/poor design. <strong>Defense: Boundary Setting (Redesign).</strong></dd>
            </dl>
            
            
        </aside>
    </div>
</div>

<script>
    let budget = 100;
    let stress = 0.30;
    let currentScenario = null;
    let userDiagnosis = null;

    const scenarios = [
        { 
            title: "The Robben Island Challenge", 
            desc: "The regime has moved you to a 7x7 foot cell with minimal sunlight. The environment is engineered to force a psychological collapse.",
            type: "intentional", correct: "mandela", hit: 0.25, cost: 35 
        },
        { 
            title: "Pandemic Burnout", 
            desc: "The ICU is at 200% capacity. You are being asked to ignore your biological needs to save others. The harm is systemic, not malicious.",
            type: "incidental", correct: "boundary", hit: 0.15, cost: 20 
        },
        {
            title: "The Thiokol Pressure",
            desc: "Managers are pressuring you to sign off on a launch you know is unsafe. They are threatening your career to ensure compliance.",
            type: "intentional", correct: "mandela", hit: 0.20, cost: 25
        }
    ];

    function closeOrientation() {
        document.getElementById('orientation-overlay').classList.add('hidden');
        updateUI();
    }

    function triggerEvent() {
        if (scenarios.length === 0) {
            document.getElementById('event-title').innerText = "Simulation Complete";
            document.getElementById('event-desc').innerText = "Audit your logs. Did you protect your substrate or did you truncate?";
            document.getElementById('next-btn').disabled = true;
            return;
        }
        currentScenario = scenarios.shift();
        document.getElementById('event-title').innerText = currentScenario.title;
        document.getElementById('event-desc').innerText = currentScenario.desc;
        
        document.getElementById('diag-controls').classList.remove('hidden');
        document.getElementById('cycle-controls').classList.add('hidden');
    }

    function diagnose(type) {
        userDiagnosis = type;
        document.getElementById('diag-controls').classList.add('hidden');
        document.getElementById('defense-controls').classList.remove('hidden');
    }

    function defend(method) {
        const isCorrect = (userDiagnosis === currentScenario.type && method === currentScenario.correct);
        
        // Damage Calculation
        const finalStress = isCorrect ? currentScenario.hit * 0.4 : currentScenario.hit;
        const finalCost = isCorrect ? currentScenario.cost * 0.5 : currentScenario.cost;

        budget -= finalCost;
        stress += finalStress;
        
        const logEntry = document.createElement('p');
        if(isCorrect) {
            logEntry.innerHTML = `[COHERENT] <strong>${currentScenario.title}</strong>: Correct defense used. Substrate integrity preserved.`;
            logEntry.style.color = "var(--matrix-green)";
        } else {
            logEntry.innerHTML = `[DECOHERENT] <strong>${currentScenario.title}</strong>: Incorrect diagnosis or tactic. Substrate took full damage.`;
            logEntry.style.color = "var(--danger-red)";
        }
        
        document.getElementById('log').prepend(logEntry);
        document.getElementById('defense-controls').classList.add('hidden');
        document.getElementById('cycle-controls').classList.remove('hidden');
        updateUI();
    }

    function recover() {
        if(budget >= 100 && stress <= 0.3) return;
        budget = Math.min(100, budget + 15);
        stress = Math.max(0.2, stress - 0.05);
        const logEntry = document.createElement('p');
        logEntry.innerText = "[RECOVERY] Rest & Community restored metabolic reserves.";
        logEntry.style.color = "#3b82f6";
        document.getElementById('log').prepend(logEntry);
        updateUI();
    }

    function updateUI() {
        document.getElementById('budget-val').innerText = Math.round(budget);
        document.getElementById('stress-val').innerText = stress.toFixed(2);
        
        const bar = document.getElementById('sapolsky-bar');
        const width = Math.min(100, stress * 100);
        bar.style.width = width + "%";
        bar.setAttribute('aria-valuenow', width);

        const alert = document.getElementById('status-alert');
        if (stress >= 0.65) {
            bar.style.background = "var(--danger-red)";
            alert.style.display = "block";
        } else {
            bar.style.background = "var(--matrix-green)";
            alert.style.display = "none";
        }
    }
</script>
</body>
</html>
